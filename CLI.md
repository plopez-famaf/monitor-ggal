# GGAL Monitor - CLI Interface

**Interfaz REPL minimalista para monitoreo de GGAL con Kalman Filter forecasting y validaci√≥n de predicciones.**

## Quick Start

```bash
# Install dependencies
pip install -r requirements.txt

# Set API key (required)
export FINNHUB_API_KEY="your_api_key_here"

# Run CLI (Kalman Filter only - default)
python cli.py

# Run CLI with AutoML (Ensemble: Kalman + Auto-ARIMA)
export USE_AUTOML=true
python cli.py
```

## Usage

La CLI inicia un REPL interactivo con monitoreo en background (polling cada 10s):

```
GGAL Monitor CLI - Kalman Filter Forecasting

Background monitoring started (10s interval)
Type 'help' for commands, 'quit' to exit

ggal> _
```

## Effectiveness Index ‚≠ê NEW

El sistema ahora incluye un **√çndice de Efectividad (0-100)** que mide la calidad de las predicciones en tiempo real:

- **Directional Accuracy (33.3%)**: ¬øPredijimos correctamente si el precio subir√≠a/bajar√≠a?
- **Price Accuracy (33.3%)**: ¬øQu√© tan cerca estuvo el precio predicho del real? (basado en MAPE)
- **Calibration (33.3%)**: ¬øEl precio real cay√≥ dentro del intervalo de confianza 95%?

**Ratings:**
- 80-100: EXCELLENT
- 70-79: GOOD
- 60-69: FAIR
- 50-59: POOR
- 0-49: VERY POOR

### Available Commands

| Command | Alias | Description |
|---------|-------|-------------|
| `status` | `s` | Current price + effectiveness index |
| `forecast` | `f` | Show current 5-min forecast (auto-generated) |
| `signal` | `sig` | Trading signal (BUY/SELL/HOLD) |
| `accuracy` | `acc` | Detailed effectiveness index breakdown |
| `stats` | - | Statistics (max, min, avg, range) |
| `metrics` | `m` | Same as accuracy |
| `history` | `h` | Recent price history (last 10) |
| `symbols` | - | List all available symbols |
| `switch` | `sw` | Switch between symbols (e.g., `sw btc`) |
| `alerts` | - | Configure price alerts (on/off/threshold) |
| `model` | - | Switch forecasting model (kalman/automl) |
| `help` | - | Show help |
| `quit` | `q` | Exit |

## Continuous Forecasting (Background)

The system now runs **continuous forecasting** in the background:

- **Auto-generation**: Forecasts are generated every 30 seconds (configurable via `FORECAST_INTERVAL`)
- **Auto-validation**: Predictions are automatically validated after 5 minutes
- **Push alerts**: Alerts appear immediately when price change exceeds threshold (default 0.1%)
- **Alert expiry**: Each alert is valid for 5 minutes (forecast horizon)
- **No manual trigger**: The `forecast` command only displays the current forecast (doesn't generate new)

```bash
# Configure forecast interval (default: 30 seconds)
export FORECAST_INTERVAL=30
python cli.py
```

**How it works:**
1. Background thread generates forecasts every 30s for all symbols
2. Each forecast is stored in `last_forecasts` and tracked for validation
3. If price change ‚â• threshold, **alert appears immediately** (push notification)
4. Alert shows: symbol, direction, %, price range, and expiry time (5 min)
5. After 5 minutes, predictions are validated against actual prices
6. Expired alerts are automatically removed from active list
7. Use `forecast` command to view the current prediction anytime

### Examples

**Check current price with effectiveness:**
```
ggal> status
‚Üó $45.67 +0.34 (+0.75%) | 14:23:45

Prediction Effectiveness: ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 82/100 (GOOD)
  ‚îú‚îÄ Direction: 15/20 correct (75.0%)
  ‚îú‚îÄ Accuracy: MAPE 0.34% (excellent)
  ‚îî‚îÄ Calibration: 90% within CI (optimal)
```

**View current 5-minute forecast (auto-generated):**
```
ggal> forecast
Forecast at: 14:23:45
Target time: 14:28:45
Horizon:     5 min (fixed)
Current:     $45.67
Predicted:   ‚Üó $45.92
Change:      +0.25 (+0.55%)
Velocity:    0.0025 $/min
IC 95%:      $45.68 - $46.16
Trend:       UP
Model:       Kalman Filter

Note: This forecast was auto-generated by the background thread.
      A new forecast will be generated in ~30 seconds.
```

**With AutoML enabled:**
```
ggal> forecast
Forecast at: 14:23:45
Target time: 14:28:45
Horizon:     5 min (fixed)
Current:     $45.67
Predicted:   ‚Üó $45.89
Change:      +0.22 (+0.48%)
Velocity:    0.0022 $/min
IC 95%:      $45.65 - $46.13
Trend:       UP
Model:       Ensemble (Kalman + Auto-ARIMA)
ARIMA order: (2, 1, 1)
```

**Effectiveness index breakdown:**
```
ggal> accuracy

Prediction Effectiveness Index
‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë 82/100 (GOOD)

Component Scores:
  ‚ñ∏ Direction: 75.0% (15/20 correct)
  ‚ñ∏ Price Accuracy: MAPE 0.34% (MAE $0.015)
  ‚ñ∏ Calibration: 90.0% within 95% CI

Good: Reliable predictions
Based on 20 validated predictions (5-min horizon)
```

**Trading signal:**
```
ggal> signal
BUY ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà 82/100
Strong upward momentum with low uncertainty
```

**Price alerts (automatic push notifications):**
```
ggal> alerts
Alert Settings:
  Status: ON
  Threshold: 0.1%

Usage:
  alerts on   - Enable alerts
  alerts off  - Disable alerts
  alerts 0.5  - Set threshold to 0.5%

# When a significant price movement is detected (appears immediately):

üîî ALERTA DE PRECIO:
  ‚Ä¢ BTC (Bitcoin / USDT): ‚Üó +0.85% | $43,521.00 ‚Üí $43,891.00
  V√°lida hasta: 14:28:45

ggal> _  (continues waiting for input)

# View active alerts anytime:
ggal> (press Enter without command)

üîî ALERTAS ACTIVAS:
  ‚Ä¢ GGAL (Banco Galicia ADR): ‚Üó +0.65% | $45.67 ‚Üí $45.97
    V√°lida hasta: 14:28:30
  ‚Ä¢ BTC (Bitcoin / USDT): ‚Üò -1.20% | $43,521 ‚Üí $43,000
    V√°lida hasta: 14:29:15
```

**Statistics:**
```
ggal> stats
Samples:  127
Max:      $46.12
Min:      $44.89
Avg:      $45.23
Range:    $1.23
```

**Model accuracy (alias for 'accuracy'):**
```
ggal> metrics
(Same output as 'accuracy' command)
```

**Price history:**
```
ggal> history
‚îè‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚î≥‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚î≥‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îì
‚îÉ Time     ‚îÉ  Price ‚îÉ Change            ‚îÉ
‚î°‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚ïá‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚ïá‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚î©
‚îÇ 14:20:15 ‚îÇ $45.34 ‚îÇ +0.12 (+0.26%)    ‚îÇ
‚îÇ 14:20:25 ‚îÇ $45.41 ‚îÇ +0.19 (+0.42%)    ‚îÇ
‚îÇ 14:20:35 ‚îÇ $45.67 ‚îÇ +0.45 (+0.99%)    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Multi-symbol switching:**
```
ggal> symbols
Available Symbols:
  ‚Ä¢ GGAL - Banco Galicia ADR (stock)
  ‚Ä¢ BTC - Bitcoin / USDT (crypto)

ggal> switch btc
Switched to BTC (Bitcoin / USDT)

btc> status
‚Üó $43,521.45 +234.12 (+0.54%) | 14:23:45

btc> forecast
(Shows Bitcoin forecast)

btc> sw ggal
Switched to GGAL (Banco Galicia ADR)
```

**Model switching (runtime):**
```
ggal> model
Current Model: Kalman Filter

Usage:
  model kalman  - Use Kalman Filter only (fast, lightweight)
  model automl  - Use Ensemble (Kalman + Auto-ARIMA)

ggal> model automl
‚úì Switched to AutoML Ensemble
Combines Kalman + Auto-ARIMA (30+ samples needed)

ggal> forecast
(Now using ensemble model)

ggal> model kalman
‚úì Switched to Kalman Filter
Fast, lightweight forecasting (10+ samples needed)
```

## AutoML Mode (Optional)

El sistema incluye un modo **AutoML** que utiliza Auto-ARIMA para selecci√≥n autom√°tica de par√°metros:

### ¬øCu√°ndo usar AutoML?

**Usar Kalman Filter (default):**
- Startup r√°pido (1s)
- Baja latencia (<50ms por forecast)
- Menor uso de memoria (~30MB)
- √ìptimo para trading de alta frecuencia

**Usar AutoML Ensemble:**
- Mejor accuracy potencial
- Combina Kalman + Auto-ARIMA
- Reentrenamiento autom√°tico cada 10 datos
- Requiere 30+ muestras (vs 10 para Kalman)
- Latencia: ~100-150ms (primera vez: 2-5s)

### Activaci√≥n

**Opci√≥n 1: Durante runtime (recomendado)**
```bash
# Inicia con Kalman (default)
python cli.py

ggal> model automl     # Cambia a AutoML
ggal> model kalman     # Vuelve a Kalman
```

**Opci√≥n 2: Al iniciar**
```bash
export USE_AUTOML=true
python cli.py
```

**Ventaja del comando `model`:** Puedes cambiar entre modelos sin reiniciar, comparar resultados en tiempo real.

### Componentes del Ensemble

El Ensemble combina:
1. **Kalman Filter** (40% peso): R√°pido, suave, bueno para tendencias
2. **Auto-ARIMA** (60% peso): Adaptativo, encuentra mejor orden (p,d,q)

Los pesos se pueden ajustar autom√°ticamente basados en effectiveness index.

## CLI Features

### Command History & Autocomplete

La CLI incluye:
- **Historial de comandos**: Usa ‚Üë/‚Üì para navegar comandos anteriores
- **Autocompletado**: Presiona Tab para autocompletar comandos
- **Comandos guardados en memoria**: Persisten durante la sesi√≥n

Ejemplos:
```
ggal> for[TAB]        ‚Üí forecast
ggal> sw[TAB] btc[TAB] ‚Üí switch btc
```

### Timestamps

Todos los forecasts muestran:
- **Forecast at**: Hora en que se gener√≥ la predicci√≥n
- **Target time**: Hora objetivo (forecast at + 5 min)

Esto permite validar f√°cilmente las predicciones manualmente.

## Architecture

```
cli.py                  # REPL interface (this module)
monitor.py              # Background price polling
forecaster.py           # Kalman Filter forecasting
automl_forecaster.py    # Auto-ARIMA forecasting
ensemble_forecaster.py  # Ensemble (Kalman + AutoML)
prediction_tracker.py   # Accuracy validation
app.py                  # Flask API (optional, for web interface)
```

### Design Philosophy

- **Minimal boilerplate**: ~250 lines total
- **Maximum performance**: Rich rendering + background threading
- **No dependencies bloat**: Only `rich` library for UI
- **Zero configuration**: Just set API key and run

### Performance

- Startup time: ~1 second
- Command latency: <50ms (data already in memory)
- Memory footprint: ~30MB (1000 price points)
- Background polling: 10s interval (configurable)

## Requirements

- Python 3.10+
- Finnhub API key (free tier: 60 calls/min)
- Terminal with Unicode support (for arrows/bars)

## Advanced Usage

**One-shot commands (future):**
```bash
python cli.py --command status
python cli.py --command "forecast 10"
```

**Custom polling interval (future):**
```bash
python cli.py --interval 5  # Poll every 5 seconds
```

## Troubleshooting

**"Waiting for data..."**
- Normal on startup, wait 10-30 seconds for first API call
- Check API key: `echo $FINNHUB_API_KEY`

**"Need at least 10/15 data points"**
- Forecast needs 10 points (~2 minutes of monitoring)
- Trading signal needs 15 points (~3 minutes)

**No price updates**
- Check if market is open (Mon-Fri 9:30 AM - 4:00 PM ET)
- Outside market hours, prices stay frozen at last close

**"API key inv√°lida"**
- Get free key at: https://finnhub.io
- Demo token no longer works (401 Unauthorized)

## Comparison: CLI vs Web

| Feature | CLI | Web (app.py) |
|---------|-----|--------------|
| Startup time | 1s | 3s |
| Memory usage | 30MB | 60MB |
| Dependencies | rich | Flask + rich |
| Browser required | ‚ùå | ‚úÖ |
| SSH-friendly | ‚úÖ | ‚ùå |
| Scriptable | ‚úÖ | ‚ö†Ô∏è (API only) |
| Charts | Text | Chart.js |
| Auto-refresh | Background | JavaScript polling |

**Recommendation:** Use CLI for development/monitoring, Web for dashboards.

## License

Same as parent project (see README.md)
